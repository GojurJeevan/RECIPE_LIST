/*!
 * opensearch - lib/client.js
 * Copyright(c) 2013 Tmall.com
 * Author: tangyao <tangyao@alibaba-inc.com>
 */

'use strict';

/**
 * Module dependencies.
 */
var crypto = require('crypto');

/**
 * md5 hash
 *
 * @param {String} s
 * @return {String} md5 hash string
 * @api public
 */
exports.md5 = function (s) {
  var md5sum = crypto.createHash('md5');
  md5sum.update(s, Buffer.isBuffer(s) ? 'binary' : 'utf8');
  return md5sum.digest('hex');
};

var dontNeedEncoding = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_.* '; // 末位为空格

exports.encode = function (s) {
  var out = [];
  for (var i = 0, len = s.length; i < len; i++) {
    var c = s[i];
    if (dontNeedEncoding.indexOf(c) !== -1) {
      if (c === ' ') {
        c = '+';
      }
      out.push(c);
    } else {
      var buf = new Buffer(c).toString('hex').toUpperCase();
      for (var j = 0, jlen = buf.length / 2; j < jlen; j++) {
        out.push('%' + buf.substring(j * 2, (j+1) * 2));
      }
    }
  }
  return out.join('');
};

/**
 * 将参数转换为URL
 * @param  {Object} params 查询参数
 */
exports.querystring = function (params) {
  var q = '';
  for (var key in params) {
    var value = String(params[key]);
    q += (key + '=' + exports.encode(value) + '&');
  }
  q = q.substring(0, q.length - 1);
  return q;
};


